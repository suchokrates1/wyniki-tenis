<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Kort {{ kort_id }}</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }

    .overlay-main {
      position: absolute;
      top: 0;
      left: 0;
      width: 1920px;
      height: 1080px;
      border: none;
      z-index: 0;
    }

    .top-strip {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-evenly;
      align-items: flex-start;
      padding-top: 10px;
      z-index: 10;
      background: transparent;
    }

    .kort-label {
      font-family: sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: white;
      text-shadow: 1px 1px 2px black;
      background: rgba(0, 0, 0, 0.6);
      padding: 3px 8px;
      border-radius: 6px;
    }

    .status-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: sans-serif;
      color: #f8fafc;
      text-shadow: 1px 1px 2px black;
      background: rgba(0, 0, 0, 0.45);
      padding: 8px 12px;
      border-radius: 8px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
      font-size: 0.9rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid transparent;
      width: fit-content;
    }

    .status-on {
      background: rgba(74, 222, 128, 0.18);
      color: #4ade80;
      border-color: rgba(74, 222, 128, 0.45);
    }

    .status-off {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border-color: rgba(239, 68, 68, 0.45);
    }

    .status-info {
      font-size: 0.85rem;
    }

    .pause-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.18);
      border: 1px solid rgba(248, 113, 113, 0.4);
      color: #fecaca;
    }

    .status-badge-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(148, 163, 184, 0.3);
      border: 1px solid rgba(248, 250, 252, 0.4);
      color: #f8fafc;
    }

    .status-badge-not_found {
      background: rgba(248, 113, 113, 0.3);
      border-color: rgba(248, 113, 113, 0.6);
      color: #ffe4e6;
    }

    .mini-meta {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
    }

    .mini-meta time,
    .mini-meta span {
      display: block;
    }
  </style>
</head>
<body>

  <!-- Główna nakładka -->
  <iframe class="overlay-main" src="{{ main_overlay }}"></iframe>

  {% set snapshot = main_snapshot | default({}) %}
  <div class="status-panel" aria-live="polite">
    <span class="status-pill status-{{ 'on' if snapshot.overlay_is_on else 'off' }}">Overlay: {{ snapshot.overlay_label | default('OFF') }}</span>
    {% if snapshot.badges %}
    <div class="status-badge-strip">
      {% for badge in snapshot.badges %}
      <span class="status-badge status-badge-{{ badge.key | default('generic') }}"{% if badge.description %} title="{{ badge.description }}"{% endif %}>{{ badge.label }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <span class="status-info">Status: {{ snapshot.status_label | default('Brak danych') }}</span>
    {% if snapshot.pause_active %}
    <span class="pause-indicator">{{ snapshot.pause_label }}</span>
    {% endif %}
    {% if snapshot.last_updated %}
    <time class="status-info" datetime="{{ snapshot.last_updated }}">Ostatnia aktualizacja: {{ snapshot.last_updated }}</time>
    {% else %}
    <span class="status-info">Ostatnia aktualizacja: brak danych</span>
    {% endif %}
  </div>

  <!-- Pasek górny z miniaturami -->
  <div class="top-strip">
    {% set default_mini_config = {
      "view_width": 690,
      "view_height": 150,
      "display_scale": 0.8,
      "offset_x": -30,
      "offset_y": 0,
      "label": {"position": "top-left", "offset_x": 8, "offset_y": 6},
    } %}
    {% if config is defined and config.kort_all is defined and config.kort_all.top_left is defined %}
      {% set fallback_mini_config = config.kort_all.top_left %}
    {% else %}
      {% set fallback_mini_config = default_mini_config %}
    {% endif %}
    {% if mini_config is not defined or not mini_config %}
      {% set mini_config = fallback_mini_config %}
    {% endif %}

    {% set default_label_config = default_mini_config.label %}
    {% set fallback_label_config = fallback_mini_config.label | default(default_label_config) %}
    {% set active_label_config = mini_config.label | default(fallback_label_config) %}
    {% set label_position = active_label_config.position | default(default_label_config.position) %}
    {% set label_offset_x = active_label_config.offset_x | default(default_label_config.offset_x) %}
    {% set label_offset_y = active_label_config.offset_y | default(default_label_config.offset_y) %}
    {% set computed_label_style = "position: absolute;" %}
    {% if "top" in label_position %}
      {% set computed_label_style = computed_label_style ~ " top: " ~ label_offset_y ~ "px;" %}
    {% else %}
      {% set computed_label_style = computed_label_style ~ " bottom: " ~ label_offset_y ~ "px;" %}
    {% endif %}
    {% if "center" in label_position %}
      {% set computed_label_style = computed_label_style ~ " left: calc(50% + " ~ label_offset_x ~ "px); transform: translateX(-50%);" %}
    {% elif "right" in label_position %}
      {% set computed_label_style = computed_label_style ~ " right: " ~ label_offset_x ~ "px;" %}
    {% else %}
      {% set computed_label_style = computed_label_style ~ " left: " ~ label_offset_x ~ "px;" %}
    {% endif %}
    {% set effective_label_style = mini_label_style | default(computed_label_style) %}

    {% if mini_config %}
      {% for mini in mini_overlays | default([]) %}
        <div class="mini-overlay"
             style="width: {{ (mini_config.view_width | default(fallback_mini_config.view_width | default(default_mini_config.view_width)))
                                * (mini_config.display_scale | default(fallback_mini_config.display_scale | default(default_mini_config.display_scale))) }}px;
                    height: {{ (mini_config.view_height | default(fallback_mini_config.view_height | default(default_mini_config.view_height)))
                                 * (mini_config.display_scale | default(fallback_mini_config.display_scale | default(default_mini_config.display_scale))) }}px;
                    position: relative;
                    overflow: hidden;
                    border-radius: 8px;
                    box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
                    background: rgba(0, 0, 0, 0.4);">

          <!-- Przesunięty fragment wycinka -->
          <iframe
            src="{{ mini.overlay }}"
            style="
              width: 1920px;
              height: 1080px;
              transform: scale({{ mini_config.display_scale | default(fallback_mini_config.display_scale | default(default_mini_config.display_scale)) }});
              transform-origin: bottom left;
              position: absolute;
              left: {{ mini_config.offset_x | default(fallback_mini_config.offset_x | default(default_mini_config.offset_x)) }}px;
              bottom: {{ mini_config.offset_y | default(fallback_mini_config.offset_y | default(default_mini_config.offset_y)) }}px;
              border: none;">
          </iframe>

          <!-- Etykieta kortu -->
          <div class="kort-label" style="{{ effective_label_style }}">
            <div>Kort {{ mini.kort_id }}</div>
            <div class="mini-meta">
              <span class="status-pill status-{{ 'on' if mini.overlay_is_on else 'off' }}" style="font-size: 0.75rem; padding: 0.15rem 0.55rem;">Overlay: {{ mini.overlay_label }}</span>
              <span>Status: {{ mini.status_label }}</span>
              {% if mini.pause_active %}
              <span class="pause-indicator" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">{{ mini.pause_label }}</span>
              {% endif %}
              {% if mini.last_updated %}
              <time datetime="{{ mini.last_updated }}">Ostatnia aktualizacja: {{ mini.last_updated }}</time>
              {% else %}
              <span>Ostatnia aktualizacja: brak danych</span>
              {% endif %}
            </div>
          </div>

        </div>
      {% endfor %}
    {% endif %}
  </div>
</body>
</html>
